#!/usr/bin/env ansible-playbook
---
- name: playbook
  hosts: all
  vars:
  pre_tasks:
  - name: Install required packages
    apt:
      pkg: ['htop', 'tmux', 'jq', 'python3-docker', 'python3-pip', 'pwgen']
      state: 'present'
      update_cache: yes
      cache_valid_time: 3600
  - name: Install docker-compose python package
    ansible.builtin.pip:
      name: docker-compose

  roles:
  # https://github.com/geerlingguy/ansible-role-docker
  - {role: "geerlingguy.docker", docker_users: ["vagrant"], tags: ["docker"]}
  post_tasks:
    - name: Check if secrets are present
      stat:
        path: /vagrant/.ci/deploy/localenv/.env
      register: secrets

    - name: Create secrets
      shell: ./data/create_docker_compose_env.sh > .env
      args:
        chdir: /vagrant/.ci/deploy/localenv/
      when: secrets.stat.exists == False

#    - name: Create and start services
#      shell: docker compose --file .ci/deploy/localenv/docker-compose.yml up --detach
#      args:
#        chdir: /vagrant/

